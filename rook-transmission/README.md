# Rook Transmission SDK

This SDK allows apps to transmit Health Data to the ROOK server.

## Features

* Upload sleep summaries
* Upload physical summaries
* Upload body summaries
* Upload physical events

## Installation

![Maven Central](https://img.shields.io/maven-central/v/com.rookmotion.android/rook-transmission?color=%23F44336)

Add the following to your dependencies (app level build.gradle):

```groovy
implementation 'com.rookmotion.android:rook-transmission:version'
```

## Getting started

To get authorization to use this SDK, you'll need to install and configure
the [rook-auth](https://mvnrepository.com/artifact/com.rookmotion.android/rook-auth) SDK.

### Logging

If you want to see the logs generated by this SDK

When creating an instance of `RookTransmissionManager` provide a logLevel:

```kotlin
RookTransmissionManager(logLevel = "ADVANCED")
```

Available levels:

* "ADVANCED" -> All logs from API. All logs from SDK.
* "BASIC" -> Basic logs from API. All logs from SDK.
* "NONE" -> No logs.

## Usage

Create an instance of `RookTransmissionManager` providing:

* A Context
* An [apiURL](https://docs.tryrook.io/docs/Definitions#api_url) without HTTPS.
* A [userID](https://docs.tryrook.io/docs/Definitions#user_id)
    * The userID must be previously registered
      using the [rook-users](https://mvnrepository.com/artifact/com.rookmotion.android/rook-users) SDK.
* A [clientUUID](https://docs.tryrook.io/docs/Definitions#client_uuid)
* A [clientPassword](https://docsbeta.tryrook.io/docs/Definitions#client_password)

```kotlin
val manager = RookTransmissionManager(
    context,
    "api.rook-connect.dev",
    USER_ID,
    CLIENT_UUID,
    CLIENT_PASSWORD
)
```

### Enqueueing

There are multiple functions to enqueue health data they follow the convention `enqueue_data_type` when calling any of
these functions youâ€™ll need to provide an instance of the required data type.

Enqueued data will be stored in an internal database until it is uploaded.

To enqueue a Sleep Summary call `enqueueSleepSummary` and provide an instance of `SleepSummaryItem`:

```kotlin
fun enqueueSleep() {
    val now = toUTC(ZonedDateTime.now())
    val startDatetime = now.minusHours(16)

    scope.launch {
        try {
            val item = SleepSummaryItem(
                sourceOfData = "Health Connect",
                dateTime = now,
                sleepStartDatetime = startDatetime,
                sleepEndDatetime = startDatetime.plusHours(8),
                sleepDate = startDatetime.toLocalDate(),
                sleepDurationSeconds = 64800,
                timeInBedSeconds = 64800,
            )

            manager.enqueueSleepSummary(item)

            // Success
        } catch (e: Exception) {
            // Manage error
        }
    }
}
```

Remember to send the dates and date times with UTC timezone.

rook_extraction SDKs
like [rook_health_connect](https://mvnrepository.com/artifact/com.rookmotion.android/rook-health-connect)
deliver the date with ISO-8601 (UTC) format like `2023-01-06T22:00:22.065Z`.

To convert an ISO-8601 (UTC) to a ZonedDateTime you can use the following helper:

```kotlin
object RookDateTimeUtils {
    private val utc: ZoneId get() = ZoneId.of("UTC")
    private val rookDateTimeZFormatter: DateTimeFormatter get() = DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm:ss.SSSz")
    private val rookDateTimeFormatter: DateTimeFormatter get() = DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm:ss.SSS")
    private val rookDateFormatter: DateTimeFormatter get() = DateTimeFormatter.ISO_LOCAL_DATE

    fun toUTC(date: ZonedDateTime): ZonedDateTime {
        val dateUTC = if (date.offset == ZoneOffset.UTC) {
            date
        } else {
            date.withZoneSameInstant(utc)
        }

        val rookDateString = rookDateTimeFormatter.format(dateUTC).plus("Z")

        return stringToZonedDateTime(rookDateString)
    }

    fun stringToZonedDateTime(string: String): ZonedDateTime {
        val date = ZonedDateTime.parse(string, rookDateTimeZFormatter)

        return if (date.offset == ZoneOffset.UTC) {
            date
        } else {
            date.withZoneSameInstant(utc)
        }
    }

    fun stringToLocalDate(string: String): LocalDate {
        return LocalDate.parse(string, rookDateFormatter)
    }
}
```

### Clear queue

If you want to clear queued data, so it won't be sent the next time you perform an upload call `clearQueued_data_type`:

```kotlin
fun clearSleepSummaryQueue() {
    scope.launch {
        try {
            manager.clearQueuedSleepSummaries()

            // Success
        } catch (e: Exception) {
            // Manage error
        }
    }
}
```

### Uploading

To upload (send) all enqueued health data call `uploadAll`, this will upload all types of data and
delete
them from the internal Database.

```kotlin
fun uploadAll() {
    scope.launch {
        try {
            manager.uploadAll()

            // Success
        } catch (e: Exception) {
            // Manage error
        }
    }
}
```

* You can also upload specific types of data these functions will follow the convention:
  `upload_data_type`.
