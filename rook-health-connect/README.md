# Rook Health Connect

This SDK allows apps to extract data from Google Health Connect. **rook_health_connect** is part
of Rook Extraction; a series of SDKs dedicated to extract health data from a variety of
providers.

* This SDK was developed with the Health
  Connect [native SDK](https://developer.android.com/guide/health-and-fitness/health-connect), so
  all it's limitations and requirements apply for this SDK as well.

## Features

* Check for Health Connect APK availability.
* Check and request permissions.
* Retrieve a sleep summary from a specific date.
* Retrieve a physical summary from a specific date.
* Retrieve all physical events from a specific date.
* Retrieve a body summary from a specific date.

## Installation

![Maven Central](https://img.shields.io/maven-central/v/com.rookmotion.android/rook-health-connect?color=%23F44336)

Add the following to your dependencies (app level build.gradle):

```groovy
implementation 'com.rookmotion.android:rook-health-connect:version'
```

## Getting started

To get permission of usage you'll need to install and configure
the [rook-auth](https://mvnrepository.com/artifact/com.rookmotion.android/rook-auth)
SDK.

### Android configuration

In your values folder create a **health_permissions.xml** file with the following content:

```text
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <array name="health_permissions">
        <item>androidx.health.permission.SleepSession.READ</item>
        <item>androidx.health.permission.Steps.READ</item>
        <item>androidx.health.permission.Distance.READ</item>
        <item>androidx.health.permission.FloorsClimbed.READ</item>
        <item>androidx.health.permission.ElevationGained.READ</item>
        <item>androidx.health.permission.OxygenSaturation.READ</item>
        <item>androidx.health.permission.Vo2Max.READ</item>
        <item>androidx.health.permission.TotalCaloriesBurned.READ</item>
        <item>androidx.health.permission.ActiveCaloriesBurned.READ</item>
        <item>androidx.health.permission.HeartRate.READ</item>
        <item>androidx.health.permission.RestingHeartRate.READ</item>
        <item>androidx.health.permission.HeartRateVariabilityRmssd.READ</item>
        <item>androidx.health.permission.ExerciseSession.READ</item>
        <item>androidx.health.permission.Steps.READ</item>
        <item>androidx.health.permission.Speed.READ</item>
        <item>androidx.health.permission.StepsCadence.READ</item>
        <item>androidx.health.permission.Weight.READ</item>
        <item>androidx.health.permission.Height.READ</item>
        <item>androidx.health.permission.BloodGlucose.READ</item>
        <item>androidx.health.permission.BloodPressure.READ</item>
        <item>androidx.health.permission.Hydration.READ</item>
        <item>androidx.health.permission.BodyTemperature.READ</item>
    </array>
</resources>
```

Then in your **AndroidManifest.xml** add a query for Health Connect

```xml

<manifest>
    <queries>
        <package android:name="com.google.android.apps.healthdata" />
    </queries>
</manifest>
```

In the same manifest, inside the Activity that you use to display your app's privacy policy add a
reference to `health_permissions`
and an intent filter for the Health Connect permissions action:

```xml

<activity android:name=".ui.health_connect.HCPrivacyPolicyActivity" android:enabled="true"
    android:exported="true">

    <meta-data android:name="health_permissions" android:resource="@array/health_permissions" />

    <intent-filter>
        <action android:name="androidx.health.ACTION_SHOW_PERMISSIONS_RATIONALE" />
    </intent-filter>
</activity>
```

In your build.gradle (app) set your min and target sdk version like below:

```groovy
minSdk 26
targetSdk 33
```

* This package will only work with devices of sdk 28 or later, the `minSdk 26` is to keep
  compatibility with other rook SDK than can be used with older sdks.

### Logging

If you want to see the logs generated by this SDK

When creating an instance of `RookHealthConnectManager` provide a logLevel:

```kotlin
RookHealthConnectManager(logLevel = "ADVANCED")
```

Available levels:

* "ADVANCED" -> All logs from API. All logs from SDK.
* "BASIC" -> Basic logs from API. All logs from SDK.
* "NONE" -> No logs.

## Usage

Create an instance of `RookHealthConnectManager` providing a context:

```kotlin
val manager = RookHealthConnectManager(context)
```

### Privacy policy

Health connect requires a privacy policy where you tell your users how you will handle and use their
data.

In the [android configuration](#android-configuration) section an intent filter was added to listen
when your app is launched from said intent you can use a dedicated Activity or if you are using a
**Single activity architecture** you can use Deeplink. You can find an example of the
first approach in our demo app.

### Check compatibility

Before using any of the features of `rook_health_connect` you need to ensure the user's device is
compatible with Health Connect and check if
the [APK](https://play.google.com/store/apps/details?id=com.google.android.apps.healthdata) is
installed.

Call `checkAvailability` to check for the APK, this will return an `AvailabilityStatus`.

| Status        | Description                                 | What to do                                      |
|---------------|---------------------------------------------|-------------------------------------------------|
| INSTALLED     | APK is installed                            | Proceed to check permissions                    |
| NOT_INSTALLED | APK is not installed                        | Prompt the user to install Health Connect.      |
| NOT_SUPPORTED | This device does not support health connect | Take the user out of the health connect section |

### Permissions

#### Check

There are dedicated functions for each health pillar (Sleep, Physical and Body) to check
permissions, these functions follow the convention: `has_data_type_Permissions`

You can also call `hasAllPermissions` to check if your app has all the permissions required to
extract data from all health pillars.

```kotlin
fun checkPermissions() {
    scope.launch {
        val result = manager.hasAllPermissions()

        if (result) {
            // The app has permissions.
        } else {
            // The app does not have permissions.
        }
    }
}
```

#### Request

There are dedicated functions for each health pillar (Sleep, Physical and Body) to request
permissions, these functions follow the convention: `request_data_type_Permissions`

You can also call `requestAllPermissions` and provide an `Activity` instance to request all health
pillar permissions.

```kotlin
fun requestPermissions(activity: Activity) {
    val result = manager.requestAllPermissions(activity)

    if (result) {
        // A request to Health Connect to open the permissions screen was send.
        // Health Connect can receive the request but refuse to open the permissions screen, in those cases 'result' will also be true
    } else {
        // The request was not send.
    }
}
```

**Permissions denied**

If the user clicks cancel or if navigates away from the permissions screen, Health Connect will take
it as if the user denied the permissions.

If the user 'denies' the permissions 2 times your app will be blocked by Health Connect, this is
permanent and cannot be undone even if the user uninstalls your app.

When your app is blocked any permissions request will be ignored.

To solve this problem we recommend yo also include a `Open Health Connect` button in your
permissions UI this button will call `openHealthConnectSettings`, there your users can manually
grant permissions to your app.

```kotlin
fun openHealthConnectSettings() {
    val result = manager.openHealthConnectSettings()

    if (result) {
        // A request to open Health Connect was send.
    } else {
        // The request was not send.
    }
}
```

### Retrieving data

To retrieve any type of summary/event you need to provide a date. This date cannot be the current
day and cannot be older than 29 days. See the examples below:

| Current date | Provided date | Is valid?                          |
|--------------|---------------|------------------------------------|
| 2023-01-08   | 2023-01-08    | No, the date is from today         |
| 2023-01-08   | 2023-01-07    | Yes, the date is from yesterday    |
| 2023-01-08   | 2022-11-01    | No, the date is older than 29 days |
| 2023-01-08   | 2023-01-01    | Yes, the date is 7 days old        |

To get health data call `get_data_type` and provide a `ZonedDateTime` instance of the day your want to
retrieve the data from.

For example if you want to get yesterday's sleep summary call `getSleepSummary`. It will return
an `SleepSummary` instance or thrown an exception if an error happens
or if there is not sleep data on that day.

```kotlin
fun getSleepSummary() {
    scope.launch {
        try {
            val date = ZonedDateTime.now().minusDays(1)
            val result = manager.getSleepSummary(date)

            // Success
        } catch (e: Exception) {
            // Manage error
        }
    }
}
```

### Keeping track of the last time a summary was retrieved

Health Connect does not allow to retrieve data on background, so every time your users open your app
you should retrieve the data manually to help you retrieving the data of the days the user did not
open your app we store in preferences the last date data was retrieved from (even if that attempt
resulted in no data being found).

Depending of the data type, there are multiple functions to retrieve that date, they follow the
convention: `get_data_type_LastDate`

It will return a `ZonedDateTime` instance.

#### Example

Let's suppose that one of your users opens the app at `2023-01-10` the app then retrieves a sleep
summary from yesterday (`2023-01-09`) with `getSleepSummary`, gets the summary and sends it to
backend.

Then the user forgets to open the app until `2023-01-15`, then you'll call `getSleepSummaryLastDate`
it will return `2023-01-09` in a ZonedDateTime instance. Now, in a loop, you can recover data from the
days the user did not open the app (`2023-01-10` to `2023-01-14`).

An example using sleep summaries is detailed below:

```kotlin
fun recoverLostDays() {
    scope.launch {
        val today = LocalDate.now()
        var date = manager.getSleepSummaryLastDate().toLocalDate()

        date = date.plusDays(1)

        while (date.isBefore(today)) {
            try {
                val result = manager.getSleepSummary(date.atStartOfDay(ZoneId.systemDefault()))

                // Success
            } catch (e: Exception) {
                // Manage error
            }

            date = date.plusDays(1)
        }
    }
}
```
