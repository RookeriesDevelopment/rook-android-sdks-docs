# Rook Users SDK

This SDK allows [clients](https://docs.tryrook.io/docs/Definitions/#client) to register
their [Users](https://docs.tryrook.io/docs/Definitions/#User) in ROOK server.

## Features

* Register users in Health Connect

## Installation

![Maven Central](https://img.shields.io/maven-central/v/com.rookmotion.android/rook-users?style=for-the-badge&logo=gradle&label=rook-users&color=7200F7)
![Maven Central](https://img.shields.io/maven-central/v/com.rookmotion.android/rook-bom?style=for-the-badge&logo=gradle&label=rook-bom&color=7200F7)

In your **build.gradle** (app module) add the required dependencies. We recommend using our BoM to get latest compatible
versions:

```groovy
implementation platform("com.rookmotion.android:rook-bom:bom-version")
implementation 'com.rookmotion.android:rook-users'
```

Add the following to your dependencies (app level build.gradle):

```groovy
implementation 'com.rookmotion.android:rook-users:version'
```

## Getting started

### Android configuration

In your build.gradle (app) set your min and target sdk version like below:

```groovy
minSdk 26
targetSdk 34
```

In your gradle.properties (Project level) add the following to disable R8 full mode:

```properties
android.enableR8.fullMode=false
```

If you want to enable full mode add the following rules to proguard-rules.pro:

```text
# Keep generic signature of Call, Response (R8 full mode strips signatures from non-kept items).
-keep,allowobfuscation,allowshrinking interface retrofit2.Call
-keep,allowobfuscation,allowshrinking class retrofit2.Response

# With R8 full mode generic signatures are stripped for classes that are not
# kept. Suspend functions are wrapped in continuations where the type argument
# is used.
-keep,allowobfuscation,allowshrinking class kotlin.coroutines.Continuation
```

### Environment

The `RookUsersEnvironment` enum allows to quickly configure the behaviour of **rook-users**, e.g. the api
used to communicate with ROOK servers.

Available environments:

* SANDBOX ➞ Use this during your app development process.
* PRODUCTION ➞ Use this ONLY when your app is published to the PlayStore.

You can use the `BuildConfig.DEBUG` property of you app to configure the environment:

```kotlin
val environment = if (BuildConfig.DEBUG) RookUsersEnvironment.SANDBOX
else RookUsersEnvironment.PRODUCTION
```

### Logging

If you want to see the logs generated by this SDK pass `enableLogs` as `true` when initialing. You can use
the `BuildConfig.DEBUG` property of you app to configure logging:

```kotlin
val enableLogs = BuildConfig.DEBUG
```

## Usage

### Initialization

To initialize this SDK call `RookUsersConfiguration.initRookUsers` and provide:

* Context
* [clientUUID](https://docs.tryrook.io/docs/Definitions#client_uuid)
* [Environment](#environment)
* [EnableLogs](#logging)

```kotlin
val environment = if (BuildConfig.DEBUG) RookUsersEnvironment.SANDBOX
else RookUsersEnvironment.PRODUCTION

val enableLogs = BuildConfig.DEBUG

val result = RookUsersConfiguration.initRookUsers(
  context = context,
  clientUUID = clientUUID,
  environment = environment,
  enableLogs = enableLogs
)

result.fold(
    {
        // Initialized
    },
    {
        val error = "InitializationError: ${it.localizedMessage}"

        // Error initializing
    }
)
```

#### Recommendations

When you call `initRookUsers` an HTTP request is made, so you should only call it once. We recommend to code this process in
your application's initialization, e.g. the splash screen.

### RookUsersManager

The `RookUsersManager` class contains all **rook-users** features, to create an instance provide:

* Context
* [clientUUID](https://docs.tryrook.io/docs/Definitions#client_uuid)
* [clientPassword](https://docsbeta.tryrook.io/docs/Definitions#client_password)

```kotlin
val rookUsersManager = RookUsersManager(
    context = context,
    clientUUID = CLIENT_UUID,
    clientPassword = CLIENT_PASSWORD,
)
```

### Registering Users

To register a user call `registerRookUser` providing a userID and a userType. It
will return an instance of `RookUser`. After a successful registration it will store a `RookUser`
instance in preferences so the next time you call `registerRookUser` the local value will be
returned. Unless you provide a different userID, in that case it will behave like the first time.

The `userID` is defined by you, so feel free to use the same ID your app uses to identify it's
users. If you provide an ID which is already exists in the server it will only store it in
preferences.

The `userType` determines where the user will be created. E.g. if you want to create a user for
Health Connect use `UserType.HEALTH_CONNECT`:

```kotlin
fun registerUser() {
    scope.launch {
        try {
            val result = rookUsersManager.registerRookUser(USER_ID, UserType.HEALTH_CONNECT)

            // Success
        } catch (e: Exception) {
            // Manage error
        }
    }
}
```

### Removing registered users from preferences

This SDK already manages the case were you need to register a different userID (the new userID
will replace the previous one in preferences).

If you want to manually remove a userID call `removeUserFromPreferences` and provide the type of
user you want to remove it will return a boolean indicating if the operation was successful.

```kotlin
fun remove() {
    scope.launch {
        try {
            val result = rookUsersManager.removeUserFromPreferences(UserType.HEALTH_CONNECT)

            // Success
        } catch (e: Exception) {
            // Manage error
        }
    }
}
```

* `removeUserFromPreferences` will only delete from local storage, the user will remain registered
  on server.

## Additional information

The first time your users use this SDK they MUST have an active internet connection otherwise
the request will fail and the userID won't be registered or stored.
